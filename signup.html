<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Google API 스크립트 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script src="js/drive.js"></script>
</head>

<body>
    <div class="container">
        <h1>회원가입</h1>

        <div id="google-signin-box" class="content-box">
            <p>먼저 Google 계정으로 로그인하세요.</p>
            <div class="button-group">
                <!-- Google ID 로그인 버튼 컨테이너 -->
                <div id="g_id_onload"
                    data-client_id="396207225030-154qdg1rqog8s809t5ud19clqfq1o6gn.apps.googleusercontent.com"
                    data-context="signup" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                    data-text="signup_with" data-size="large" data-logo_alignment="left">
                </div>
            </div>
            <p class="small-text">Google 계정으로 간편하게 회원가입하세요.</p>
            <p>이미 회원이신가요? <a href="login.html">로그인</a></p>
        </div>

        <div id="signup-form-box" class="content-box" style="display: none;">
            <h2>추가 정보 입력</h2>
            <p>Google 계정 <span id="user-email" class="user-email"></span>으로 로그인되었습니다.</p>

            <form id="signup-form">
                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="phone">전화번호</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>

                <div class="form-group">
                    <label for="address">주소</label>
                    <input type="text" id="address" name="address" required>
                </div>

                <button type="submit" class="button primary">회원가입 완료</button>
                <button type="button" id="cancel-btn" class="button">취소</button>
            </form>
        </div>

        <div id="loading" class="content-box" style="display: none;">
            <div class="loader"></div>
            <p>처리 중입니다...</p>
        </div>

        <div id="success" class="content-box" style="display: none;">
            <h2>회원가입 완료!</h2>
            <p>회원가입이 성공적으로 완료되었습니다.</p>
            <p>이제 로그인하여 서비스를 이용하실 수 있습니다.</p>
            <a href="login.html" class="button primary">로그인 페이지로 이동</a>
        </div>
    </div>

    <script>
        let googleUser = null;
        let userEmail = '';
        let userName = '';

        // Google 로그인 응답 처리 함수
        function handleCredentialResponse(response) {
            console.log("Google 로그인 응답:", response);

            // JWT 토큰 디코딩 (base64)
            const token = response.credential;
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            const payload = JSON.parse(jsonPayload);
            console.log("디코딩된 페이로드:", payload);

            // 사용자 정보 추출
            userEmail = payload.email;
            userName = payload.name || '';

            // 이미 가입된 사용자인지 확인
            const storedUserData = localStorage.getItem('userData');
            if (storedUserData) {
                const userData = JSON.parse(storedUserData);
                if (userData.email === userEmail) {
                    alert('이미 가입된 계정입니다. 로그인 페이지로 이동합니다.');
                    window.location.href = 'login.html';
                    return;
                }
            }

            // 이메일 표시
            document.getElementById('user-email').textContent = userEmail;

            // 이름 필드에 Google에서 가져온 이름 미리 채우기
            if (userName) {
                document.getElementById('name').value = userName;
            }

            // 폼 표시
            document.getElementById('google-signin-box').style.display = 'none';
            document.getElementById('signup-form-box').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Google API 초기화
            if (typeof gapi !== 'undefined') {
                gapi.load('client', function () {
                    console.log('gapi.client 로드됨');
                });
            }

            // 취소 버튼 이벤트 리스너
            document.getElementById('cancel-btn').addEventListener('click', function () {
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('google-signin-box').style.display = 'block';
            });

            // 폼 제출 이벤트 리스너
            document.getElementById('signup-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!userEmail) {
                    alert('Google 로그인이 필요합니다.');
                    document.getElementById('signup-form-box').style.display = 'none';
                    document.getElementById('google-signin-box').style.display = 'block';
                    return;
                }

                // 폼 데이터 가져오기
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;

                // 로딩 표시
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                try {
                    // 사용자 정보 저장
                    const userData = {
                        name: name,
                        email: userEmail,
                        phone: phone,
                        address: address
                    };

                    console.log("저장할 사용자 정보:", userData);

                    // Google Sheets API 초기화 및 스프레드시트에 사용자 정보 저장
                    try {
                        console.log("Google Sheets API 초기화 시작");
                        await initSheetsAPI();
                        console.log("Google Sheets API 초기화 완료");

                        console.log("스프레드시트에 사용자 정보 저장 시작");
                        const result = await registerUserToSpreadsheet(userData);
                        console.log("스프레드시트에 사용자 정보 저장 성공:", result);
                    } catch (sheetError) {
                        console.error("스프레드시트 저장 오류:", sheetError);
                        alert("스프레드시트 저장 중 오류가 발생했습니다: " + sheetError.message);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('signup-form-box').style.display = 'block';
                        return;
                    }

                    // 로컬 스토리지에 사용자 정보 저장
                    localStorage.setItem('userData', JSON.stringify(userData));
                    console.log("로컬 스토리지에 사용자 정보 저장 성공");

                    // 성공 메시지 표시
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('success').style.display = 'block';

                } catch (error) {
                    console.error('회원가입 오류:', error);
                    alert('회원가입 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('signup-form-box').style.display = 'block';
                }
            });
        });
    </script>
</body>

</html>