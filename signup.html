<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>

<body>
    <div class="container">
        <h1>회원가입</h1>

        <div id="google-login-box" class="content-box">
            <p>Google 계정으로 로그인하세요.</p>
            <div class="button-group">
                <!-- Google ID 로그인 버튼 컨테이너 -->
                <div id="g_id_onload"
                    data-client_id="396207225030-154qdg1rqog8s809t5ud19clqfq1o6gn.apps.googleusercontent.com"
                    data-context="signup" data-us_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_promt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                    data-text="signup_with" data-size="large" data-logo_alignment="left">
                </div>
            </div>
            <p class="small-text">Google 계정으로 간편하게 회원가입하세요.</p>
            <p>이미 회원이신가요? <a href="login.html">로그인</a></p>
        </div>

        <div id="signup-form-box" class="content-box" style="display: none;">
            <h2>추가 정보 입력</h2>
            <p>Google 계정 <span id="user-email" class="user-email"></span>으로 로그인되었습니다.</p>

            <form id="signup-form">
                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <button type="button" id="cancel-btn" class="button">취소</button>
                <button type="submit" class="button primary">회원가입 완료</button>
            </form>
        </div>

        <div id="loading" class="content-box" style="display: none;">
            <div class="loader"></div>
            <p>처리 중입니다...</p>
        </div>

        <div id="success" class="content-box" style="display: none;">
            <h2>회원가입 완료!</h2>
            <p>회원가입이 성공적으로 완료되었습니다.</p>
            <p>이제 로그인하여 서비스를 이용하실 수 있습니다.</p>
            <a href="login.html" class="button primary">로그인 페이지로 이동</a>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script src="js/drive.js"></script>

    <script>
        let userEmail = '';
        let userName = '';
        let googleAPIInitialized = false;

        // Google API 초기화 함수
        async function initializeGoogleAPI() {
            if (googleAPIInitialized) {
                return;
            }

            try {
                await initGapi();
                googleAPIInitialized = true;
                console.log("Google API 초기화 완료");
            } catch (error) {
                console.error("Google API 초기화 실패:", error);
                throw error;
            }
        }

        // Google 로그인 처리 함수
        async function handleGoogleSignIn() {
            try {
                await initializeGoogleAPI();

                const auth2 = gapi.auth2.getAuthInstance();
                const googleUser = await auth2.signIn({
                    prompt: 'select_account'
                });

                const profile = googleUser.getBasicProfile();
                userEmail = profile.getEmail();
                userName = profile.getName();

                // 액세스 토큰 저장
                const authResponse = googleUser.getAuthResponse(true);
                sessionStorage.setItem('googleAccessToken', authResponse.access_token);

                // 이미 가입된 사용자인지 확인
                const exists = await checkUserExists(userEmail);

                if (exists) {
                    alert('이미 가입된 계정입니다. 로그인 페이지로 이동합니다.');
                    window.location.href = 'login.html';
                } else {
                    // 이메일 표시
                    document.getElementById('user-email').textContent = userEmail;

                    // 폼 표시
                    document.getElementById('google-signin-box').style.display = 'none';
                    document.getElementById('signup-form-box').style.display = 'block';
                }
            } catch (error) {
                console.error("Google 로그인 오류:", error);
                alert("Google 로그인 중 오류가 발생했습니다: " + (error.message || "알 수 없는 오류"));
            }
        }

        // 사용자가 이미 존재하는지 확인
        async function checkUserExists(email) {
            try {
                // 로컬 스토리지에서 먼저 확인
                const storedUserData = localStorage.getItem('userData');
                if (storedUserData) {
                    const userData = JSON.parse(storedUserData);
                    if (userData.email === email) {
                        return true;
                    }
                }

                // Google API 초기화
                await initializeGoogleAPI();

                // 스프레드시트에서 확인
                return new Promise((resolve, reject) => {
                    if (!gapi.client || !gapi.client.sheets) {
                        console.error("Google Sheets API가 초기화되지 않았습니다.");
                        resolve(false); // API가 없으면 새 사용자로 간주
                        return;
                    }

                    gapi.client.sheets.spreadsheets.values
                        .get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: "Sheet1!A:A", // A열만 가져옴 (이메일)
                        })
                        .then((response) => {
                            const values = response.result.values || [];
                            // 첫 번째 행은 헤더이므로 제외하고 검색
                            const emails = values.slice(1).map(row => row[0]);
                            const exists = emails.includes(email);
                            console.log("사용자 확인 결과:", email, exists ? "존재함" : "존재하지 않음");
                            resolve(exists);
                        })
                        .catch((error) => {
                            console.error("스프레드시트 데이터 가져오기 오류:", error);
                            resolve(false); // 오류 발생 시 새 사용자로 간주
                        });
                });
            } catch (error) {
                console.error("사용자 확인 중 오류:", error);
                return false; // 오류 발생 시 새 사용자로 간주
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Google 로그인 버튼 이벤트 리스너
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);

            // 취소 버튼 이벤트 리스너
            document.getElementById('cancel-btn').addEventListener('click', function () {
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('google-signin-box').style.display = 'block';
            });

            // 폼 제출 이벤트 리스너
            document.getElementById('signup-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!userEmail) {
                    alert('Google 로그인이 필요합니다.');
                    document.getElementById('signup-form-box').style.display = 'none';
                    document.getElementById('google-signin-box').style.display = 'block';
                    return;
                }

                // 폼 데이터 가져오기
                const name = document.getElementById('name').value;

                // 로딩 표시
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                try {
                    // 사용자 정보 저장
                    const userData = {
                        name: name,
                        email: userEmail
                    };

                    console.log("저장할 사용자 정보:", userData);

                    // Google Sheets API 초기화 및 스프레드시트에 사용자 정보 저장
                    try {
                        console.log("Google Sheets API 초기화 시작");
                        await initSheetsAPI();
                        console.log("Google Sheets API 초기화 완료");

                        console.log("스프레드시트에 사용자 정보 저장 시작");
                        const result = await registerUserToSpreadsheet(userData);
                        console.log("스프레드시트에 사용자 정보 저장 성공:", result);
                        
                        // 스프레드시트 정보 저장
                        if (result && result.userSpreadsheet) {
                            localStorage.setItem('userSpreadsheet', JSON.stringify(result.userSpreadsheet));
                        }
                        
                        // 로컬 스토리지에 사용자 정보 저장
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log("로컬 스토리지에 사용자 정보 저장 성공");
                        
                        // 세션 스토리지에 로그인 상태 저장
                        sessionStorage.setItem('isLoggedIn', 'true');
                        
                        // 성공 메시지 표시
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('success').style.display = 'block';
                        
                    } catch (sheetError) {
                        console.error("스프레드시트 저장 오류:", sheetError);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('signup-form-box').style.display = 'block';
                        alert("스프레드시트 저장 중 오류가 발생했습니다: " + (sheetError.message || "알 수 없는 오류"));
                        // 스프레드시트 저장 실패 시 회원가입 중단
                        return;
                    }

                } catch (error) {
                    console.error('회원가입 오류:', error);
                    alert('회원가입 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('signup-form-box').style.display = 'block';
                }
            });
            
            // 메시지 이벤트 리스너 (OAuth 콜백에서 메시지 수신)
            window.addEventListener('message', function(event) {
                // 출처 확인
                if (event.origin !== window.location.origin) return;
                
                // OAuth 응답 처리
                if (event.data && event.data.type === 'oauth-response') {
                    const accessToken = event.data.accessToken;
                    if (accessToken) {
                        sessionStorage.setItem('googleAccessToken', accessToken);
                        console.log('OAuth 액세스 토큰 수신 성공');
                    }
                }
            });
        });
    </script>
</body>

</html>