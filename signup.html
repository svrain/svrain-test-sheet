<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Google API 스크립트 로드 순서 변경 및 추가 -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>

<body>
    <div class="container">
        <h1>회원가입</h1>

        <div id="google-signin-box" class="content-box">
            <p>먼저 Google 계정으로 로그인하세요.</p>
            <div class="button-group">
                <!-- Google ID 로그인 버튼 컨테이너 -->
                <div id="g_id_onload"
                    data-client_id="396207225030-154qdg1rqog8s809t5ud19clqfq1o6gn.apps.googleusercontent.com"
                    data-context="signup" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                    data-text="signup_with" data-size="large" data-logo_alignment="left">
                </div>
            </div>
            <p class="small-text">Google 계정으로 간편하게 회원가입하세요.</p>
            <p>이미 회원이신가요? <a href="login.html">로그인</a></p>
        </div>

        <div id="signup-form-box" class="content-box" style="display: none;">
            <h2>추가 정보 입력</h2>
            <p>Google 계정 <span id="user-email" class="user-email"></span>으로 로그인되었습니다.</p>

            <form id="signup-form">
                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="phone">전화번호</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>

                <div class="form-group">
                    <label for="address">주소</label>
                    <input type="text" id="address" name="address" required>
                </div>

                <button type="submit" class="button primary">회원가입 완료</button>
                <button type="button" id="cancel-btn" class="button">취소</button>
            </form>
        </div>

        <div id="loading" class="content-box" style="display: none;">
            <div class="loader"></div>
            <p>처리 중입니다...</p>
        </div>

        <div id="success" class="content-box" style="display: none;">
            <h2>회원가입 완료!</h2>
            <p>회원가입이 성공적으로 완료되었습니다.</p>
            <p>이제 로그인하여 서비스를 이용하실 수 있습니다.</p>
            <a href="login.html" class="button primary">로그인 페이지로 이동</a>
        </div>
    </div>

    <!-- 스크립트 로드 순서 변경 -->
    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script src="js/drive.js"></script>

    <script>
        let googleUser = null;
        let userEmail = '';
        let userName = '';
        let googleAPIInitialized = false;
        let accessToken = null; // 액세스 토큰 저장 변수 추가

        // Google API 초기화 함수
        async function initializeGoogleAPI() {
            if (googleAPIInitialized) {
                return;
            }

            try {
                await initSheetsAPI();
                googleAPIInitialized = true;
                console.log("Google API 초기화 완료");
            } catch (error) {
                console.error("Google API 초기화 실패:", error);
                throw error;
            }
        }

        // Google 로그인 응답 처리 함수
        function handleCredentialResponse(response) {
            console.log("Google 로그인 응답:", response);

            // JWT 토큰 디코딩 (base64)
            const token = response.credential;
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            const payload = JSON.parse(jsonPayload);
            console.log("디코딩된 페이로드:", payload);

            // 사용자 정보 추출
            userEmail = payload.email;
            userName = payload.name || '';

            // 토큰 저장 (OAuth2 인증에 필요)
            sessionStorage.setItem('googleUserToken', token);
            accessToken = token; // 액세스 토큰 저장

            // 이미 가입된 사용자인지 확인 - 로컬 스토리지 대신 서버에서 확인
            checkUserExists(userEmail)
                .then(exists => {
                    if (exists) {
                        alert('이미 가입된 계정입니다. 로그인 페이지로 이동합니다.');
                        window.location.href = 'login.html';
                    } else {
                        // 이메일 표시
                        document.getElementById('user-email').textContent = userEmail;

                        // 이름 필드에 Google에서 가져온 이름 미리 채우기
                        if (userName) {
                            document.getElementById('name').value = userName;
                        }

                        // 폼 표시
                        document.getElementById('google-signin-box').style.display = 'none';
                        document.getElementById('signup-form-box').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("사용자 확인 오류:", error);
                    // 오류 발생 시 계속 진행 (새 사용자로 간주)
                    document.getElementById('user-email').textContent = userEmail;
                    if (userName) {
                        document.getElementById('name').value = userName;
                    }
                    document.getElementById('google-signin-box').style.display = 'none';
                    document.getElementById('signup-form-box').style.display = 'block';
                });
        }

        // 사용자가 이미 존재하는지 확인
        async function checkUserExists(email) {
            try {
                // Google API 초기화
                await initializeGoogleAPI();

                // 로컬 스토리지에서 먼저 확인
                const storedUserData = localStorage.getItem('userData');
                if (storedUserData) {
                    const userData = JSON.parse(storedUserData);
                    if (userData.email === email) {
                        return true;
                    }
                }

                // 스프레드시트에서 확인
                return new Promise((resolve, reject) => {
                    if (!gapi.client || !gapi.client.sheets) {
                        console.error("Google Sheets API가 초기화되지 않았습니다.");
                        resolve(false); // API가 없으면 새 사용자로 간주
                        return;
                    }

                    gapi.client.sheets.spreadsheets.values
                        .get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: "Sheet1!A:A", // A열만 가져옴 (이메일)
                        })
                        .then((response) => {
                            const values = response.result.values || [];
                            // 첫 번째 행은 헤더이므로 제외하고 검색
                            const emails = values.slice(1).map(row => row[0]);
                            const exists = emails.includes(email);
                            console.log("사용자 확인 결과:", email, exists ? "존재함" : "존재하지 않음");
                            resolve(exists);
                        })
                        .catch((error) => {
                            console.error("스프레드시트 데이터 가져오기 오류:", error);
                            resolve(false); // 오류 발생 시 새 사용자로 간주
                        });
                });
            } catch (error) {
                console.error("사용자 확인 중 오류:", error);
                return false; // 오류 발생 시 새 사용자로 간주
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Google API 초기화 시도
            initializeGoogleAPI().catch(error => {
                console.warn("초기 Google API 초기화 실패:", error);
            });

            // 취소 버튼 이벤트 리스너
            document.getElementById('cancel-btn').addEventListener('click', function () {
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('google-signin-box').style.display = 'block';
            });

            // 폼 제출 이벤트 리스너
            document.getElementById('signup-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!userEmail) {
                    alert('Google 로그인이 필요합니다.');
                    document.getElementById('signup-form-box').style.display = 'none';
                    document.getElementById('google-signin-box').style.display = 'block';
                    return;
                }

                // 폼 데이터 가져오기
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;

                // 로딩 표시
                document.getElementById('signup-form-box').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                try {
                    // 사용자 정보 저장
                    const userData = {
                        name: name,
                        email: userEmail,
                        phone: phone,
                        address: address
                    };

                    console.log("저장할 사용자 정보:", userData);

                    // Google Sheets API 초기화 및 스프레드시트에 사용자 정보 저장
                    try {
                        console.log("Google Sheets API 초기화 시작");
                        await initializeGoogleAPI();
                        console.log("Google Sheets API 초기화 완료");

                        // 직접 OAuth2 인증 시도
                        await authenticateWithOAuth2();

                        console.log("스프레드시트에 사용자 정보 저장 시작");
                        const result = await registerUserToSpreadsheet(userData);
                        console.log("스프레드시트에 사용자 정보 저장 성공:", result);

                        // 스프레드시트 정보 저장
                        if (result && result.userSpreadsheet) {
                            localStorage.setItem('userSpreadsheet', JSON.stringify(result.userSpreadsheet));
                        }

                        // 로컬 스토리지에 사용자 정보 저장
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log("로컬 스토리지에 사용자 정보 저장 성공");

                        // 세션 스토리지에 로그인 상태 저장
                        sessionStorage.setItem('isLoggedIn', 'true');

                        // 성공 메시지 표시
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('success').style.display = 'block';

                    } catch (sheetError) {
                        console.error("스프레드시트 저장 오류:", sheetError);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('signup-form-box').style.display = 'block';
                        alert("스프레드시트 저장 중 오류가 발생했습니다: " + (sheetError.message || "알 수 없는 오류"));
                        // 스프레드시트 저장 실패 시 회원가입 중단
                        return;
                    }

                } catch (error) {
                    console.error('회원가입 오류:', error);
                    alert('회원가입 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('signup-form-box').style.display = 'block';
                }
            });
        });

        // 직접 OAuth2 인증 시도 함수
        async function authenticateWithOAuth2() {
            return new Promise((resolve, reject) => {
                // 이미 로그인되어 있는지 확인
                if (gapi.auth2) {
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance) {
                        const isSignedIn = authInstance.isSignedIn.get();
                        if (isSignedIn) {
                            console.log("이미 OAuth2로 로그인되어 있습니다.");
                            resolve();
                            return;
                        }
                    }
                }

                // 새로운 OAuth2 인증 시도
                gapi.auth2.authorize({
                    client_id: '396207225030-154qdg1rqog8s809t5ud19clqfq1o6gn.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive',
                    prompt: 'consent',
                    response_type: 'token id_token'
                }, function (response) {
                    if (response.error) {
                        console.error("OAuth2 인증 실패:", response.error);
                        reject(new Error("OAuth2 인증 실패: " + response.error));
                    } else {
                        console.log("OAuth2 인증 성공:", response);
                        // 액세스 토큰 저장
                        accessToken = response.access_token;
                        sessionStorage.setItem('googleAccessToken', response.access_token);

                        // 액세스 토큰을 gapi 클라이언트에 설정
                        gapi.client.setToken({
                            access_token: response.access_token
                        });

                        resolve();
                    }
                });
            });
        }
    </script>
</body>

</html>