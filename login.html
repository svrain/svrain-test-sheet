<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Google API 스크립트 -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script src="js/drive.js"></script>
</head>

<body>
    <div class="container">
        <h1>로그인</h1>
        <div id="login-box" class="content-box">
            <p>Google 계정으로 로그인하세요.</p>
            <div class="button-group">
                <button id="google-signin-btn" class="button">Google 계정으로 로그인</button>
            </div>
            <p class="small-text">회원가입 시 사용한 Google 계정으로 로그인해야 합니다.</p>
            <p>아직 회원이 아니신가요? <a href="signup.html">회원가입</a></p>
        </div>

        <div id="loading" class="content-box" style="display: none;">
            <div class="loader"></div>
            <p>로그인 중입니다...</p>
        </div>
    </div>

    <script>
        // Google 로그인 처리 함수
        async function handleGoogleSignIn() {
            try {
                // 로딩 표시
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // Google API 초기화
                await initGapi();

                const auth2 = gapi.auth2.getAuthInstance();
                const googleUser = await auth2.signIn({
                    prompt: 'select_account'
                });

                const profile = googleUser.getBasicProfile();
                const email = profile.getEmail();
                const name = profile.getName();

                // 액세스 토큰 저장
                const authResponse = googleUser.getAuthResponse(true);
                try {
                    sessionStorage.setItem('googleAccessToken', authResponse.access_token);
                } catch (error) {
                    console.error("세션 스토리지 저장 오류:", error);
                }

                // 사용자 확인 - 스프레드시트에서 확인
                const exists = await checkUserExists(email);

                if (exists) {
                    // 로그인 성공
                    try {
                        sessionStorage.setItem('isLoggedIn', 'true');
                    } catch (error) {
                        console.error("세션 스토리지 저장 오류:", error);
                    }

                    // 로컬 스토리지에서 사용자 정보 가져오기
                    const storedUserData = localStorage.getItem('userData');
                    if (storedUserData) {
                        const userData = JSON.parse(storedUserData);
                        if (userData.email !== email) {
                            // 로컬 스토리지의 이메일과 다른 경우 업데이트
                            userData.email = email;
                            userData.name = name;
                            localStorage.setItem('userData', JSON.stringify(userData));
                        }
                    } else {
                        // 로컬 스토리지에 정보가 없는 경우 기본 정보 저장
                        const userData = {
                            name: name,
                            email: email
                        };
                        localStorage.setItem('userData', JSON.stringify(userData));
                    }

                    window.location.href = 'index.html';
                } else {
                    // 회원가입되지 않은 계정
                    alert('회원가입되지 않은 계정입니다. 회원가입 페이지로 이동합니다.');
                    window.location.href = 'signup.html';
                }
            } catch (error) {
                console.error("Google 로그인 오류:", error);
                alert("로그인 중 오류가 발생했습니다: " + (error.message || "알 수 없는 오류"));
                document.getElementById('loading').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
            }
        }

        // 사용자가 이미 존재하는지 확인
        async function checkUserExists(email) {
            try {
                // 로컬 스토리지에서 먼저 확인
                const storedUserData = localStorage.getItem('userData');
                if (storedUserData) {
                    const userData = JSON.parse(storedUserData);
                    if (userData.email === email) {
                        return true;
                    }
                }

                // 스프레드시트에서 사용자 확인
                await initSheetsAPI();

                return new Promise((resolve, reject) => {
                    if (!gapi.client || !gapi.client.sheets) {
                        console.error("Google Sheets API가 초기화되지 않았습니다.");
                        resolve(false); // API 오류 시 로컬 스토리지만 확인
                        return;
                    }

                    gapi.client.sheets.spreadsheets.values
                        .get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: "Sheet1!A:A", // A열만 가져옴 (이메일)
                        })
                        .then((response) => {
                            const values = response.result.values || [];
                            // 첫 번째 행은 헤더이므로 제외하고 검색
                            const emails = values.slice(1).map(row => row[0]);
                            const exists = emails.includes(email);
                            console.log("사용자 확인 결과:", email, exists ? "존재함" : "존재하지 않음");
                            resolve(exists);
                        })
                        .catch((error) => {
                            console.error("스프레드시트 데이터 가져오기 오류:", error);
                            // 오류 발생 시 로컬 스토리지로 폴백
                            resolve(storedUserData && JSON.parse(storedUserData).email === email);
                        });
                });
            } catch (error) {
                console.error("사용자 확인 중 오류:", error);
                // 오류 발생 시 로컬 스토리지로 폴백
                const storedUserData = localStorage.getItem('userData');
                return storedUserData && JSON.parse(storedUserData).email === email;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 이미 로그인되어 있는지 확인
            try {
                if (sessionStorage.getItem("isLoggedIn") === "true") {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("세션 스토리지 접근 오류:", error);
            }

            // 구글 로그인 버튼 이벤트 리스너
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
        });
    </script>
</body>

</html>